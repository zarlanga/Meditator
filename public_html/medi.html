<!DOCTYPE html>
<html>

    <head>
        <title>MEDITATOR</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body onkeydown="pruebakey(event)" onkeyup="pedo()" >

        <h1 style="text-align: center; color: darkmagenta; font-size: 40px" >Meditator</h1>
        <canvas id="myCanvas" width="400" height="400"  style="border:1px solid;background-color: coral; float:left; margin:0px 20px"></canvas>


        <p> presione cualquier tecla al inhalar y sueltela al exhalar, cuando termine haga click en calcular </p>
        <button onclick="calcular()" >calcular</button>
        <p id="resultado"></p>
        <script type="text/javascript">
            /* features
             -duracion de cada respiracion (listo)
             -respiraciones por minuto (cada cuanto calcularlas? como mostrarlas?)
             -tiempo total!
             -comparacion de inhalacion y exhalacion
             -graficar la duracion de la respiracion?
             -linea que baje y suba con la respiracion?
             -promedios de duracion de respiraciones y/o respiraciones por minutos (dividiendo la sesion en x partes?)
             -ver que onda el redondeo con las horas minutos y segundos
             
             
             
             */
            /* recuerdos var i = 0;
             var t0= Date.now(); 
             
             i++;
             alert(i +" //  "+  (Date.now() - t0) );  (en calcular)
             
             */

            var tiemposIN = [];
            var tiemposEX = [];
            var dale = true;

            var c = document.getElementById("myCanvas");
            var ctx = c.getContext("2d");

            function graficarEX() {
                ctx.beginPath();
                ctx.fillStyle = "coral";
                ctx.fillRect(0, c.height / 2, c.width, c.height / 2);
                ctx.stroke();

                ctx.beginPath();
                ctx.fillStyle = "red";
                ctx.fillRect(0, 0, c.width, c.height / 2);
                ctx.stroke();
            }

            function graficarIN() {

                ctx.beginPath();
                ctx.fillStyle = "coral";
                ctx.fillRect(0, 0, c.width, c.height / 2);
                ctx.stroke();

                ctx.beginPath();
                ctx.fillStyle = "red";
                ctx.fillRect(0, c.height / 2, c.width, c.height / 2);
                ctx.stroke();
            }

            function limpiarGrafico() {
                ctx.beginPath();
                //ctx.lineWidth = "6";
                //ctx.strokeStyle = "coral";
                ctx.fillStyle = "blue";
                ctx.fillRect(0, 0, 400, 400);
                //ctx.rect(0, 0, 400, 200);
                //ctx.rect(0, 200, 400, 200);
                ctx.stroke();
            }

            function graficarArray(arr) {

                dist = c.width / (arr.length-1);
                pmax= Math.max.apply(null, arr);
                pmin= Math.min.apply(null, arr);
                
                //alert("maximo="+pmax);
                //alert("minimo="+pmin);

                
                ctx.lineWidth = 4;
                ctx.strokeStyle = "white";
                ctx.beginPath();
                

                for (var i = 0; i < arr.length-1; i++) {
                    ctx.moveTo(dist*i, sacarY(pmin,pmax,arr[i]) );
                    ctx.lineTo(dist*(i+1), sacarY(pmin,pmax,arr[i+1]));
                    ctx.stroke();
                    
                }
                

            }
            
            function sacarY(min, max, y) {
                distY= c.height /(max-min);
                yfin = c.height - (y-min)*distY;
                return yfin;
            }

            
            function calcular() {
                //dale=false;

                var testo = "";
                var tTotal;
                var tHoras;
                var tMin;
                var tSeg;
                var rpm = []; //array para guardar las respiraciones por minuto (eventualmente sacar promedios parciales?)
                var rpmAC = 0; // acumulador para calcular el promedio
                limpiarGrafico();

                for (var p = 0; p < tiemposIN.length - 1; p++) {
                    tx = (tiemposIN[p + 1] - tiemposIN[p]);
                    rpm[rpm.length] = (60000 / tx).toFixed(2);
                    rpmAC += Number(rpm[p]);
                    testo += tx / 1000 + "segundos////" + rpm[p] + "rpm  <br>";
                }
                
                graficarArray(rpm);

                testo += "<br>total respiraciones: " + tiemposIN.length + "<br>";

                testo += "<br>Respiraciones por minuto promedio: " + (rpmAC / (tiemposIN.length - 1)).toFixed(2) + "<br>";

                tTotal = (tiemposIN[tiemposIN.length - 1] - tiemposIN[0]);
                tHoras = (tTotal / 3600000).toFixed(0);


                tTotal -= tHoras * 3600000;

                tMin = (tTotal / 60000).toFixed(0);
                tTotal -= tMin * 60000;
                // alert(tTotal);
                tSeg = (tTotal / 1000).toFixed(2);


                testo += "<br>tiempo total: " + tHoras + " horas, " + tMin + " min " + tSeg + "seg";
                document.getElementById("resultado").innerHTML = testo;

                tiemposIN = [];
                tiemposEX = [];
            }

            function pedo() {
                dale = true;
                tiemposEX[tiemposEX.length] = Date.now();
                graficarEX();
            }

            function pruebakey(e) {
                if (dale) {
                    tiemposIN[tiemposIN.length] = Date.now();
                    graficarIN();
                    dale = false;
                }

            }




        </script>
    </body>
</html>